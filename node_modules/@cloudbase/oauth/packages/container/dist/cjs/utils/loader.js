"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.loadJSExportFunction = exports.getExportFunction = void 0;
var go_wams_exec_1 = __importDefault(require("../go_wams_exec"));
var _1 = require(".");
function instantiateStreaming(resp, importObject, brotliCompressed) {
    if (brotliCompressed === void 0) { brotliCompressed = false; }
    return __awaiter(this, void 0, void 0, function () {
        var source, buffer;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    if (!(brotliCompressed || !WebAssembly.instantiateStreaming)) return [3, 3];
                    return [4, resp];
                case 1: return [4, (_a.sent()).arrayBuffer()];
                case 2:
                    source = _a.sent();
                    if (brotliCompressed) {
                        throw new Error('do not support *.br');
                    }
                    buffer = source;
                    return [2, WebAssembly.instantiate(buffer, importObject)];
                case 3: return [2, WebAssembly.instantiateStreaming(resp, importObject)];
            }
        });
    });
}
function isBrotliCompressed(url) {
    var brotliCompressed = false;
    var pathname = '';
    try {
        var location_1 = (0, _1.parseURL)(url);
        pathname = location_1.pathname;
    }
    catch (e) {
        pathname = url;
    }
    if (/\.br$/.test(pathname)) {
        brotliCompressed = true;
    }
    return brotliCompressed;
}
function getExportFunction(url, module, mode) {
    if (mode === void 0) { mode = 'go'; }
    return __awaiter(this, void 0, void 0, function () {
        var importObject, go, brotliCompressed, reuslt;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    importObject = __assign({ env: {
                            memoryBase: 0,
                            tableBase: 0,
                            memory: new WebAssembly.Memory({
                                initial: 256,
                            }),
                        } }, module);
                    brotliCompressed = isBrotliCompressed(url);
                    if (mode === 'go') {
                        go = new go_wams_exec_1.default();
                        go._initedModulePromise = new Promise(function (resolve) {
                            go._initedModuleResolve = resolve;
                        });
                        importObject = __assign(__assign({}, go.importObject), { env: __assign(__assign({}, go.importObject.env), { exportModule: function (module) {
                                    return go._initedModuleResolve(module);
                                } }) });
                    }
                    return [4, instantiateStreaming(fetch(url), importObject, brotliCompressed)];
                case 1:
                    reuslt = _a.sent();
                    if (!(mode === 'go')) return [3, 3];
                    return [4, Promise.race([
                            go.run(reuslt.instance),
                            new Promise(function (resolve) { return setTimeout(function () {
                                resolve(null);
                            }, 500); }),
                        ])];
                case 2:
                    _a.sent();
                    return [2, {
                            callContainer: window.callContainer,
                            initContainer: window.initContainer,
                        }];
                case 3: return [2, reuslt.instance.exports];
            }
        });
    });
}
exports.getExportFunction = getExportFunction;
function loadJSExportFunction(config) {
    return __awaiter(this, void 0, void 0, function () {
        var _a, vm, vender, VENDER_KEY;
        return __generator(this, function (_b) {
            switch (_b.label) {
                case 0:
                    _a = config || {}, vm = _a.vm, vender = _a.vender;
                    VENDER_KEY = 'cloudbase_private_link_vender';
                    if (!(vender || !Object.prototype.hasOwnProperty.call(document.defaultView, VENDER_KEY))) return [3, 2];
                    return [4, loadUmdModule(vender
                            || 'https://qbase.cdn-go.cn/lcap/lcap-resource-cdngo/-/release/_npm/@cloudbase/privatelink-vender@0.0.2/dist/cdn/cloudbase.privatelink.vender.js', VENDER_KEY)];
                case 1:
                    _b.sent();
                    _b.label = 2;
                case 2: return [2, loadUmdModule(vm
                        || 'https://qbase.cdn-go.cn/lcap/lcap-resource-cdngo/-/release/_npm/@cloudbase/privatelink@0.0.1/dist/cdn/cloudbase.privatelink.vm.js', 'cloudbase_private_link')];
            }
        });
    });
}
exports.loadJSExportFunction = loadJSExportFunction;
function loadUmdModule(jsUrl, umdModuleName, targetDoc) {
    if (targetDoc === void 0) { targetDoc = document; }
    return new Promise(function (resolve, reject) {
        var win = targetDoc.defaultView;
        var script = targetDoc.createElement('script');
        script.setAttribute('src', jsUrl);
        script.setAttribute('class', umdModuleName);
        script.addEventListener('load', function () {
            if (Object.prototype.hasOwnProperty.call(win, umdModuleName)) {
                return resolve(win[umdModuleName]);
            }
            var error = new Error("Fail to load UMD module ".concat(umdModuleName, " from [").concat(jsUrl, "]."));
            return reject(error);
        });
        script.addEventListener('error', function (e) {
            var error = new Error("main bundle [".concat(umdModuleName, "] load failed from [").concat(jsUrl, "]: ").concat((e === null || e === void 0 ? void 0 : e.message) || ''));
            reject(error);
        });
        if (targetDoc.body) {
            targetDoc.body.appendChild(script);
        }
        else {
            targetDoc.head.appendChild(script);
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3V0aWxzL2xvYWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNBLGlFQUFnQztBQUNoQyxzQkFBNEI7QUFFNUIsU0FBZSxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsWUFBWSxFQUFFLGdCQUF3QjtJQUF4QixpQ0FBQSxFQUFBLHdCQUF3Qjs7Ozs7O3lCQUMxRSxDQUFBLGdCQUFnQixJQUFJLENBQUMsV0FBVyxDQUFDLG9CQUFvQixDQUFBLEVBQXJELGNBQXFEO29CQUNqQyxXQUFNLElBQUksRUFBQTt3QkFBakIsV0FBTSxDQUFDLFNBQVUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFBOztvQkFBekMsTUFBTSxHQUFHLFNBQWdDO29CQUMvQyxJQUFJLGdCQUFnQixFQUFFO3dCQUNwQixNQUFNLElBQUksS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUE7cUJBQ3ZDO29CQUVLLE1BQU0sR0FBRyxNQUFNLENBQUE7b0JBQ3JCLFdBQU8sV0FBVyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsWUFBWSxDQUFDLEVBQUE7d0JBR3RELFdBQU8sV0FBVyxDQUFDLG9CQUFvQixDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsRUFBQTs7OztDQUM1RDtBQUVELFNBQVMsa0JBQWtCLENBQUMsR0FBRztJQUM3QixJQUFJLGdCQUFnQixHQUFHLEtBQUssQ0FBQTtJQUU1QixJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUE7SUFDakIsSUFBSTtRQUNGLElBQU0sVUFBUSxHQUFHLElBQUEsV0FBUSxFQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQzlCLFFBQVEsR0FBRyxVQUFRLENBQUMsUUFBUSxDQUFBO0tBQzdCO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDVixRQUFRLEdBQUcsR0FBRyxDQUFBO0tBQ2Y7SUFF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Q0FBQTtBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBpbXBvcnQgZGVjb21wcmVzcyBmcm9tICdicm90bGkvZGVjb21wcmVzcydcbmltcG9ydCBHbyBmcm9tICcuLi9nb193YW1zX2V4ZWMnXG5pbXBvcnQgeyBwYXJzZVVSTCB9IGZyb20gJy4nXG5cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbnRpYXRlU3RyZWFtaW5nKHJlc3AsIGltcG9ydE9iamVjdCwgYnJvdGxpQ29tcHJlc3NlZCA9IGZhbHNlKSB7XG4gIGlmIChicm90bGlDb21wcmVzc2VkIHx8ICFXZWJBc3NlbWJseS5pbnN0YW50aWF0ZVN0cmVhbWluZykge1xuICAgIGNvbnN0IHNvdXJjZSA9IGF3YWl0IChhd2FpdCByZXNwKS5hcnJheUJ1ZmZlcigpXG4gICAgaWYgKGJyb3RsaUNvbXByZXNzZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignZG8gbm90IHN1cHBvcnQgKi5icicpXG4gICAgfVxuICAgIC8vIGNvbnN0IGJ1ZmZlciA9IGJyb3RsaUNvbXByZXNzZWQgPyBkZWNvbXByZXNzKG5ldyBJbnQ4QXJyYXkoc291cmNlKSkgOiBzb3VyY2VcbiAgICBjb25zdCBidWZmZXIgPSBzb3VyY2VcbiAgICByZXR1cm4gV2ViQXNzZW1ibHkuaW5zdGFudGlhdGUoYnVmZmVyLCBpbXBvcnRPYmplY3QpXG4gIH1cblxuICByZXR1cm4gV2ViQXNzZW1ibHkuaW5zdGFudGlhdGVTdHJlYW1pbmcocmVzcCwgaW1wb3J0T2JqZWN0KVxufVxuXG5mdW5jdGlvbiBpc0Jyb3RsaUNvbXByZXNzZWQodXJsKSB7XG4gIGxldCBicm90bGlDb21wcmVzc2VkID0gZmFsc2VcblxuICBsZXQgcGF0aG5hbWUgPSAnJ1xuICB0cnkge1xuICAgIGNvbnN0IGxvY2F0aW9uID0gcGFyc2VVUkwodXJsKVxuICAgIHBhdGhuYW1lID0gbG9jYXRpb24ucGF0aG5hbWVcbiAgfSBjYXRjaCAoZSkge1xuICAgIHBhdGhuYW1lID0gdXJsXG4gIH1cblxuICBpZiAoL1xcLmJyJC8udGVzdChwYXRobmFtZSkpIHtcbiAgICBicm90bGlDb21wcmVzc2VkID0gdHJ1ZVxuICB9XG4gIHJldHVybiBicm90bGlDb21wcmVzc2VkXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRFeHBvcnRGdW5jdGlvbih1cmwsIG1vZHVsZSwgbW9kZSA9ICdnbycpIHtcbiAgbGV0IGltcG9ydE9iamVjdCA9IHtcbiAgICBlbnY6IHtcbiAgICAgIG1lbW9yeUJhc2U6IDAsXG4gICAgICB0YWJsZUJhc2U6IDAsXG4gICAgICBtZW1vcnk6IG5ldyBXZWJBc3NlbWJseS5NZW1vcnkoe1xuICAgICAgICBpbml0aWFsOiAyNTYsXG4gICAgICB9KSxcbiAgICAgIC8vIHRhYmxlOiBuZXcgV2ViQXNzZW1ibHkuVGFibGUoe1xuICAgICAgLy8gICBpbml0aWFsOiAyLFxuICAgICAgLy8gICBlbGVtZW50OiAnYW55ZnVuYycsXG4gICAgICAvLyB9KSxcbiAgICB9LFxuICAgIC4uLm1vZHVsZSxcbiAgfVxuICBsZXQgZ29cbiAgY29uc3QgYnJvdGxpQ29tcHJlc3NlZCA9IGlzQnJvdGxpQ29tcHJlc3NlZCh1cmwpXG5cbiAgaWYgKG1vZGUgPT09ICdnbycpIHtcbiAgICBnbyA9IG5ldyBHbygpXG4gICAgZ28uX2luaXRlZE1vZHVsZVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgZ28uX2luaXRlZE1vZHVsZVJlc29sdmUgPSByZXNvbHZlXG4gICAgfSlcbiAgICBpbXBvcnRPYmplY3QgPSB7XG4gICAgICAuLi5nby5pbXBvcnRPYmplY3QsXG4gICAgICBlbnY6IHtcbiAgICAgICAgLi4uZ28uaW1wb3J0T2JqZWN0LmVudixcbiAgICAgICAgZXhwb3J0TW9kdWxlKG1vZHVsZSkge1xuICAgICAgICAgIHJldHVybiBnby5faW5pdGVkTW9kdWxlUmVzb2x2ZShtb2R1bGUpXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IHJldXNsdCA9IGF3YWl0IGluc3RhbnRpYXRlU3RyZWFtaW5nKGZldGNoKHVybCksIGltcG9ydE9iamVjdCwgYnJvdGxpQ29tcHJlc3NlZClcblxuICBpZiAobW9kZSA9PT0gJ2dvJykge1xuICAgIGF3YWl0IFByb21pc2UucmFjZShbXG4gICAgICBnby5ydW4ocmV1c2x0Lmluc3RhbmNlKSxcbiAgICAgIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHJlc29sdmUobnVsbClcbiAgICAgIH0sIDUwMCksKSxcbiAgICBdKVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGNhbGxDb250YWluZXI6ICh3aW5kb3cgYXMgYW55KS5jYWxsQ29udGFpbmVyLFxuICAgICAgaW5pdENvbnRhaW5lcjogKHdpbmRvdyBhcyBhbnkpLmluaXRDb250YWluZXIsXG4gICAgfVxuICB9XG5cbiAgLy8gaWYgKG1vZGUgPT09ICdnbycpIHtcbiAgLy8gICBnby5ydW4ocmV1c2x0Lmluc3RhbmNlKVxuICAvLyAgIGNvbnN0IG1vZHVsZSA9IGF3YWl0IGdvLl9pbml0ZWRNb2R1bGVQcm9taXNlXG4gIC8vICAgcmV0dXJuIG1vZHVsZVxuICAvLyB9XG5cbiAgcmV0dXJuIHJldXNsdC5pbnN0YW5jZS5leHBvcnRzXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkSlNFeHBvcnRGdW5jdGlvbihjb25maWc/OiB7IHZtOiBzdHJpbmc7IHZlbmRlcj86IHN0cmluZyB9KSB7XG4gIGNvbnN0IHsgdm0sIHZlbmRlciB9ID0gY29uZmlnIHx8IHt9XG4gIGNvbnN0IFZFTkRFUl9LRVkgPSAnY2xvdWRiYXNlX3ByaXZhdGVfbGlua192ZW5kZXInXG5cbiAgaWYgKHZlbmRlciB8fCAhT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGRvY3VtZW50LmRlZmF1bHRWaWV3LCBWRU5ERVJfS0VZKSkge1xuICAgIGF3YWl0IGxvYWRVbWRNb2R1bGUoXG4gICAgICB2ZW5kZXJcbiAgICAgICAgfHwgJ2h0dHBzOi8vcWJhc2UuY2RuLWdvLmNuL2xjYXAvbGNhcC1yZXNvdXJjZS1jZG5nby8tL3JlbGVhc2UvX25wbS9AY2xvdWRiYXNlL3ByaXZhdGVsaW5rLXZlbmRlckAwLjAuMi9kaXN0L2Nkbi9jbG91ZGJhc2UucHJpdmF0ZWxpbmsudmVuZGVyLmpzJyxcbiAgICAgIFZFTkRFUl9LRVksXG4gICAgKVxuICB9XG5cbiAgcmV0dXJuIGxvYWRVbWRNb2R1bGUoXG4gICAgdm1cbiAgICAgIHx8ICdodHRwczovL3FiYXNlLmNkbi1nby5jbi9sY2FwL2xjYXAtcmVzb3VyY2UtY2RuZ28vLS9yZWxlYXNlL19ucG0vQGNsb3VkYmFzZS9wcml2YXRlbGlua0AwLjAuMS9kaXN0L2Nkbi9jbG91ZGJhc2UucHJpdmF0ZWxpbmsudm0uanMnLFxuICAgICdjbG91ZGJhc2VfcHJpdmF0ZV9saW5rJyxcbiAgKVxufVxuXG5mdW5jdGlvbiBsb2FkVW1kTW9kdWxlKGpzVXJsOiBzdHJpbmcsIHVtZE1vZHVsZU5hbWU6IHN0cmluZywgdGFyZ2V0RG9jOiBEb2N1bWVudCA9IGRvY3VtZW50KSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCB3aW4gPSB0YXJnZXREb2MuZGVmYXVsdFZpZXdcblxuICAgIGNvbnN0IHNjcmlwdCA9IHRhcmdldERvYy5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKVxuICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoJ3NyYycsIGpzVXJsKVxuICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgdW1kTW9kdWxlTmFtZSlcbiAgICBzY3JpcHQuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsICgpID0+IHtcbiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwod2luLCB1bWRNb2R1bGVOYW1lKSkge1xuICAgICAgICByZXR1cm4gcmVzb2x2ZSh3aW5bdW1kTW9kdWxlTmFtZSBhcyBhbnldKVxuICAgICAgfVxuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoYEZhaWwgdG8gbG9hZCBVTUQgbW9kdWxlICR7dW1kTW9kdWxlTmFtZX0gZnJvbSBbJHtqc1VybH1dLmApXG4gICAgICByZXR1cm4gcmVqZWN0KGVycm9yKVxuICAgIH0pXG5cbiAgICBzY3JpcHQuYWRkRXZlbnRMaXN0ZW5lcignZXJyb3InLCAoZSkgPT4ge1xuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoYG1haW4gYnVuZGxlIFske3VtZE1vZHVsZU5hbWV9XSBsb2FkIGZhaWxlZCBmcm9tIFske2pzVXJsfV06ICR7ZT8ubWVzc2FnZSB8fCAnJ31gKVxuICAgICAgcmVqZWN0KGVycm9yKVxuICAgIH0pXG4gICAgaWYgKHRhcmdldERvYy5ib2R5KSB7XG4gICAgICB0YXJnZXREb2MuYm9keS5hcHBlbmRDaGlsZChzY3JpcHQpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRhcmdldERvYy5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdClcbiAgICB9XG4gIH0pXG59XG4iXX0=