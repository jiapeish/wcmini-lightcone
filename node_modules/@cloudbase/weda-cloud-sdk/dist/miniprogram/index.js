/*!
 * @cloudbase/weda-cloud-sdk
 * Copyright© 2024 Tencent
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@isaacs/ttlcache"),require("mobx"),require("@cloudbase/adapter-interface")):"function"==typeof define&&define.amd?define(["exports","@isaacs/ttlcache","mobx","@cloudbase/adapter-interface"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).CloudSDK={},e.TTLCache,e.mobx,e.adapterInterface)}(this,(function(e,t,n,r){"use strict";function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=o(t);function s(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}function a(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function c(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}function u(e,t,n,r,o){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?o.call(e,n):o?o.value=n:t.set(e,n),n}class d extends Error{constructor(e,t,n){super(t),this.code=e,this.name="TCBError",this.original=n}}function l(e,t){return!!e&&Object.prototype.hasOwnProperty.call(e,t)}const f={};let p;function h(e){if(!p)throw new Error("app config not inited");return e?p[e]:p}function g(){}function v(e){p=Object.assign(p||{},e)}function m(e){return!e&&p.useLegacyDatasource?"lcap-common-service":"lowcode-datasource"+(p.isProd?"":"-preview")}function y(e,t){return e.length===t.length&&e.every(((e,n)=>e===t[n]))}const w=[];function I(e,...t){const n=w.find((n=>n[0]===e&&y(n[1],t)));if(n)return n[2];const r=e(...t);return w.push([e,t,r]),r}function S(e,t){if(!e)return e;return t.reduce(((t,n)=>(l(e,n)&&(t[n]=e[n]),t)),{})}const O={};function b(e,t){O[e]=t}function _(e,t){const n=O[e];return n&&"function"==typeof n?n(t):n}function A(){return"tcb-api"===h("endpointType")}function x(e){const t=e=>({status:"fulfilled",value:e}),n=e=>({status:"rejected",reason:e});return Promise.all(e.map((e=>Promise.resolve(e).then(t,n))))}function T(e){return"string"==typeof e}function P(e){return"[object Object]"===Object.prototype.toString.call(e)}const U=e=>{const t=t=>{for(const n in e)e.hasOwnProperty(n)&&(t[n]=U(e[n]));return t},n=null==e?"NullOrUndefined":Object.prototype.toString.call(e).slice(8,-1);if(["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"].includes(n))return e.slice();switch(n){case"Object":return t(Object.create(Object.getPrototypeOf(e)));case"Array":return t([]);case"Date":return new Date(e.valueOf());case"RegExp":return new RegExp(e.source,`${e.global?"g":""}${e.ignoreCase?"i":""}${e.multiline?"m":""}${e.sticky?"y":""}${e.unicode?"u":""}`);default:return e}};function C(e){const t=h("datasetProfiles");return e?t[e]:t}class D{constructor(e){this.localStorage=(null==e?void 0:e.localStorage)||globalThis.localStorage}getItem(e){return a(this,void 0,void 0,(function*(){return this.localStorage.getItem(e)}))}removeItem(e){return a(this,void 0,void 0,(function*(){this.localStorage.removeItem(e)}))}setItem(e,t){return a(this,void 0,void 0,(function*(){this.localStorage.setItem(e,t)}))}getItemSync(e){return this.localStorage.getItem(e)}setItemSync(e,t){this.localStorage.setItem(e,t)}removeItemSync(e){this.localStorage.removeItem(e)}}const E=/^[^:]+:\/\/[^/]+(\/[^?#]+)/;function k(e){if(e)return function(t,n){var r;return a(this,void 0,void 0,(function*(){let o;const i=null===(r=null==n?void 0:n.headers)||void 0===r?void 0:r["x-request-id"];try{const r=Object.assign({},n);r.body&&"string"!=typeof r.body&&(r.body=JSON.stringify(r.body)),o=yield e(Object.assign(Object.assign({},r),{url:t,method:r.method||"GET"})),o.code&&(o={error:o.code,error_description:o.message||o.code,request_id:o.requestId})}catch(e){o={error:"unreachable",error_description:e.message}}if(o.request_id||(o.request_id=i),o.error)throw o.error_uri=N(t),o;return o}))}}function N(e){return E.test(e)?RegExp.$1:e}function j(e,t){return a(this,void 0,void 0,(function*(){if(e.privatelink){let n;if(e.getPrivatelinkAdapter){const t=yield e.getPrivatelinkAdapter();t&&(n=t)}else try{n="undefined"!=typeof window?window.tcbAdapterPrivatelink:void 0}catch(e){}return(null==n?void 0:n.generateAdapterWithConfig)?n.generateAdapterWithConfig({__privatelink_config__:Object.assign({pathname:"/tcb_private_link"},e.privatelink),__tcbAPIEdnpointReg__:t?new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")):void 0}):void 0}}))}const $={},R={},M={},L={on(e,t){$[e]&&console.warn(`event ${e} has been registered`),$[e]=t},once(e,t){if(M[e])return M[e].push(t);M[e]=[t]},emit(e,...t){return a(this,void 0,void 0,(function*(){$[e]&&$[e](...t),M[e]&&(M[e].forEach((e=>e(...t))),M[e]=[])}))},off(e){Array.isArray(e)?e.forEach((e=>delete $[e])):delete $[e]},listen(e,t){R[e]||(R[e]=[]),R[e].includes(t)||R[e].push(t)},broadcast(e,...t){const n=R[e];n&&0!==n.length&&n.forEach((e=>{try{e(...t)}catch(e){}}))},quit(e,t){const n=R[e];if(!n||0===n.length)return;const r=n.indexOf(t);r>-1&&n.splice(r,1)}};function F(e,t){const n=e.split(".");if(2!==n.length)return void console.warn("[weda-cloud-sdk]setStateVar: invalid varPath",e);let r=n[0];if("$page"===r){const e=h("currentPageId");if(!e||"$global"===e)return void console.warn("[weda-cloud-sdk]setStateVar: can not find currentPageId",r);r=e}const o=f[r],i=n[1];if(o&&(l(o.state.$status,i)||l(o.state,i))){if(o.state.$status[i]){if(t instanceof Error)return void(o.state.$status[i]={status:"failed",code:t.code||-1,message:t.message,error:t});"success"!==o.state.$status[i].status&&(o.state.$status[i]={status:"success"})}o.state[i]=t}}const q={setState:F,setParams:function(e,t){const n=(h("datasetProfiles")||{})[e],r=f[e];if(!r||!n||!n.params)return;const o=S(t,Object.keys(n.params));r.params||(r.params={}),Object.entries(o).forEach((([e,t])=>{r.params[e]=t}))},EVENT_BUS:L},W={tempURLMaxWaitGap:50};function V(e){Object.assign(W,e)}function B(){return"undefined"!=typeof window&&window||"undefined"!=typeof globalThis&&globalThis}function G(){try{const e=B();if(!e)return;return"undefined"==typeof wx?B().location.href:e.__wxRoute}catch(e){}}function z(){const e=B();if(null==e?void 0:e.navigator)return e.navigator.userAgent;if("undefined"!=typeof wx&&wx.getSystemInfo){let e;return wx.getSystemInfo({success(t){t&&(e=["brand","model","version","system","platform","SDKVersion","language"].map((e=>`${e}: ${t[e]}`)).join(", "))}}),e}}!function(){try{if(V({userAgent:z()}),"undefined"!=typeof window&&window&&window.top){const e=window.__wconfig||top.location.search,t={};if(/\b__wedaTarget=([^&]+)/.test(e)){const e=decodeURIComponent(RegExp.$1);e&&(t.wedaTarget=e)}/\b__useLegacy=true\b/.test(e)&&(t.useLegacyDatasource=!0),v(t)}}catch(e){}}();const K="1.0.93";function J(e,t){if("OPERATION_FAIL"===e.code||/OPERATION_FAIL/.test(e.message)){if(/FUNCTION_NOT_FOUND/.test(e.message)){const n=(null==t?void 0:t.FUNCTION_NOT_FOUND)||"找不到数据源的云函数";return new d("FUNCTION_NOT_FOUND",n,e)}if(/FUNCTIONS_EXECUTE_FAIL/.test(e.message)){const n=(null==t?void 0:t.FUNCTIONS_EXECUTE_FAIL)||"云函数执行失败";return new d("FUNCTIONS_EXECUTE_FAIL",n,e)}}if(/network request error/.test(e.message))return new d("NETWORK_ERROR","网络故障, 请检查本地网络连接是否正常",e);if(/method .* not found in datasource/i.test(e.message)){const n=(null==t?void 0:t.DS_METHOD_NOT_FOUND)||"找不到数据源的方法";return new d("DS_METHOD_NOT_FOUND",n,e)}return(null==t?void 0:t.DEFAULT_ERROR)?new d(e.code||"DEFAULT_ERROR",t.DEFAULT_ERROR,e):e}let H=new Map;const X=["wedaGetItem","wedaGetRecords","wedaGetItemV2","wedaGetRecordsV2","getApiKey"],Q=["callWedaApi"],Y=(e,t,n={},r)=>a(void 0,void 0,void 0,(function*(){const{cacheTime:o}=n||{},{methodName:i,dataSourceName:s,action:a}=e.data||{},c=o||2e4,u=r||`${i}_${s||a}`,d=JSON.stringify(e),l=H.get(u)||new Map;n.forceClear&&l.delete(d);const f=l.get(d)||{value:null,time:0,promise:null};l.set(d,f),H.set(u,l);return Date.now()-f.time>c&&!f.promise?f.promise=t(e).then((e=>{f.value=e,f.time=Date.now(),f.promise=null})).catch((e=>{f.value=e,f.time=Date.now()-c,f.promise=null})):f.promise||f.value,f.promise&&!f.value&&(yield f.promise),f.value})),Z={setItem(e,t){wx.setStorageSync(e,t)},getItem:e=>wx.getStorageSync(e),removeItem(e){wx.removeStorageSync(e)},clear(){wx.clearStorageSync()},getKeys(){const{keys:e}=wx.getStorageInfoSync();return e||[]}};const ee=new class{constructor(e){this.localStorage=(null==e?void 0:e.localStorage)||globalThis.localStorage}getItem(e){return a(this,void 0,void 0,(function*(){return this.localStorage.getItem(e)}))}removeItem(e){return a(this,void 0,void 0,(function*(){this.localStorage.removeItem(e)}))}setItem(e,t){return a(this,void 0,void 0,(function*(){this.localStorage.setItem(e,t)}))}getItemSync(e){return this.localStorage.getItem(e)}setItemSync(e,t){this.localStorage.setItem(e,t)}removeItemSync(e){this.localStorage.removeItem(e)}getKeysSync(){return this.localStorage===globalThis.localStorage?Object.keys(this.localStorage):this.localStorage.getKeys()}}({localStorage:te()?Z:void 0});function te(){if("undefined"==typeof wx)return!1;if("undefined"==typeof Page)return!1;if(!wx.getSystemInfoSync)return!1;if(!wx.getStorageSync)return!1;if(!wx.setStorageSync)return!1;if(!wx.connectSocket)return!1;if(!wx.request)return!1;try{if(!wx.getSystemInfoSync())return!1;if("qq"===wx.getSystemInfoSync().AppPlatform)return!1}catch(e){return!1}return!0}const ne=["wedaGetRecords","wedaGetItem"],re=["wedaCreateV2","wedaBatchCreateV2","wedaUpdateV2","wedaBatchUpdateV2","wedaDeleteV2","wedaBatchDeleteV2","wedaGetItemV2","wedaGetRecordsV2"],oe={wedaCreateV2:"create",wedaBatchCreateV2:"createMany",wedaUpdateV2:"update",wedaBatchUpdateV2:"updateMany",wedaDeleteV2:"delete",wedaBatchDeleteV2:"deleteMany",wedaGetItemV2:"get",wedaGetRecordsV2:"list"};function ie(){return a(this,void 0,void 0,(function*(){const e=h("initTcb"),{app:t}=yield e();return t}))}function se(e){var t,n;return a(this,void 0,void 0,(function*(){const r="boolean"!=typeof e.parseBusinessInfo||e.parseBusinessInfo,o=Object.assign({},e),i=o.name||o.dataSourceName,{methodName:s}=o,a={params:o.params,methodName:s},c=(e=>{if(e&&Object.keys(e).length)return Object.assign({swrMode:!0},e)})(null===(t=o.params)||void 0===t?void 0:t.swr);delete o.name,delete o.parseBusinessInfo,(null===(n=o.params)||void 0===n?void 0:n.swr)&&delete o.params.swr;const u=Object.assign(o.extraParams||{},{dataSourceName:i,methodName:s,defaultParams:_(i,a),params:o.params});try{const e=h("customCallDataSource");if(e){return yield e(Object.assign({},u,{parseBusinessInfo:r}))}const t=h("beforeDSRequest");t&&t(o);const n=yield ce({name:m(!0),data:u},{unwrapResult:!0,parseBusinessInfo:r,swr:c}),i=h("afterDSRequest");return i&&i(o,null,n),n}catch(e){if(console.warn(`[weda-cloud-sdk] failed to invoke datasource ${i}'s method ${s}`,e),r){const t=J(e,{FUNCTION_NOT_FOUND:`找不到数据源${i}的云函数`,DS_METHOD_NOT_FOUND:`数据源${i}中的方法${s}不存在或者未启用`,FUNCTIONS_EXECUTE_FAIL:`调用数据源${i}方法${s}失败: 请检查该数据源所有自定义方法的代码中是否存在语法错误`,DEFAULT_ERROR:`调用数据源${i}方法${s}失败: ${e.errMsg||e.message}`}),n=h("afterDSRequest");throw n&&n(o,t),t}return{code:e.errCode||-2,message:`调用数据源${i}方法${s}失败: ${e.errMsg||e.message}`}}}))}function ae(e,t){return new Proxy({},{get(n,r){if(t){const e=t(r);if(e)return e}return new Proxy({},{get:(t,n)=>(t,o)=>se({name:r,methodName:n,extraParams:o,params:t,parseBusinessInfo:e})})}})}function ce(e,t){var n;return a(this,void 0,void 0,(function*(){let r=U(e);const o=h("isProd"),i={wedaAppId:h("appID"),userAgent:W.userAgent,referrer:G(),envType:o?"prod":"pre",wedaTarget:h("wedaTarget"),"x-cloud-sdk-version":K};r.data=Object.assign({},r.data,i);const s=h("beforeCallFunction");let c;s&&(r=yield s(r));const u=h("afterCallFunction");try{if(r=ue(r),(e=>{const{methodName:t}=(null==e?void 0:e.data)||{};X.includes(t)||Q.includes(t)||(H=new Map)})(r),c=yield function(e,t){var n,r,o,i,s,c;return a(this,void 0,void 0,(function*(){const a=h("initTcb"),{methodName:u,dataSourceName:d}=e.data||{};let l=null==t?void 0:t.app;if(l||(l=(yield a()).app),!te()&&oe[u||""]&&(null==l?void 0:l.models)){const a=oe[u],c=null===(n=l.models[d])||void 0===n?void 0:n[a],f=Object.assign(Object.assign({},null===(r=e.data)||void 0===r?void 0:r.params),{envType:null===(o=e.data)||void 0===o?void 0:o.envType,"x-cloud-sdk-version":null===(i=e.data)||void 0===i?void 0:i["x-cloud-sdk-version"]});let p={};try{p=(null===(s=null==t?void 0:t.swr)||void 0===s?void 0:s.swrMode)?yield Y(f,c.bind(l),null==t?void 0:t.swr):yield c(f)}catch(e){throw e}return(null==t?void 0:t.unwrapResult)&&(p=Object.assign(Object.assign({},p),{result:p})),p}return(null===(c=null==t?void 0:t.swr)||void 0===c?void 0:c.swrMode)?yield Y(e,l.callFunction.bind(l),null==t?void 0:t.swr):yield l.callFunction(e)}))}(r,t),u&&u(r,null,JSON.parse(JSON.stringify(c))),(null===(n=null==t?void 0:t.swr)||void 0===n?void 0:n.swrMode)&&(null==c?void 0:c.error))throw c}catch(e){throw u&&u(r,e),e}if(null==t?void 0:t.unwrapResult){const{result:e}=c;if(!t.parseBusinessInfo)return e;if(e&&!e.code)return e.data;throw console.warn("[weda-cloud-sdk]failed to invoke backend, %c调用后端接口失败, 请仔细查看下述错误信息:","color: red;"),console.warn(`\tcode: ${null==e?void 0:e.code}\n\tmessage: ${null==e?void 0:e.message}\n\treason: ${null==e?void 0:e.reason}\n\trequestId: ${c.requestId}\n\toriginal response: `,c),new d(null==e?void 0:e.code,null==e?void 0:e.message,c)}return c}))}const ue=e=>{try{const{methodName:t,params:n={}}=(null==e?void 0:e.data)||{};n.hasOwnProperty("where")&&ne.includes(t||"")&&(n.where=de(n.where)),n.hasOwnProperty("filter")&&re.includes(t||"")&&(n.filter=de(n.filter))}catch(e){}return e},de=e=>{let t;return Array.isArray(e)?(t=t||[],e.forEach((e=>{const n=de(e);void 0!==n&&t.push(n)})),t):P(e)?(Object.keys(e).forEach((n=>{const r=de(e[n]);void 0!==r&&(t=t||{},t[n]=r)})),t):e},le=e=>{if(e&&Object.keys(e).length)return Object.assign({swrMode:!0},e)};function fe(e,t){return a(this,void 0,void 0,(function*(){const n=U(e),r=U(n.swr||{});return delete n.swr,ce({name:m(),data:Object.assign(Object.assign({},n),{mode:"c"})},{app:t,unwrapResult:!0,parseBusinessInfo:!0,swr:r}).catch((e=>{throw J(e,{FUNCTION_NOT_FOUND:"微搭环境异常: 未找到数据源公共云函数",FUNCTIONS_EXECUTE_FAIL:"微搭环境异常: 数据源公共云函数调用失败"})}))}))}function pe(e){return a(this,void 0,void 0,(function*(){const t=U(e);return e&&delete t.swr,fe({methodName:"callWedaApi",params:t,swr:le(null==e?void 0:e.swr)}).then((e=>e.Data))}))}const he={_:[]};function ge(e){return JSON.parse(JSON.stringify(e))}const ve={wrapperDatasourceMethod:e=>function(t){return se({name:e.dataSourceName,methodName:e.methodName,params:t})}},me=new i.default({max:1e3,ttl:2e4,checkAgeOnGet:!0});let ye=[],we=[],Ie=[];let Se=0,Oe=0;function be(){return a(this,void 0,void 0,(function*(){const e=we.splice(0);ye=ye.concat(e);try{const t=h("initTcb"),{app:n}=yield t(),r=(yield x(function(e,t){const n=[];for(let r=0;r<e.length;r+=t)n.push(e.slice(r,r+t));return n}(e,40).map((e=>n.getTempFileURL({fileList:e}))))).filter((e=>"fulfilled"===e.status));ye=ye.filter((t=>!e.includes(t)));const o=r.reduce(((e,t)=>{const n=t.value||{};return n.code&&"SUCCESS"!==n.code?(console.warn("[cloud.getTempFileURL]server response error",n),e):e.concat(n.fileList)}),[]);if(!o.length)return void _e({},e);const i={},s=[];o.forEach((e=>{var t;(l(t=e,"code")?"SUCCESS"===t.code:l(t,"status")&&!t.status)?i[e.fileID]=e.tempFileURL:(console.warn("[cloud.getTempFileURL]single item failed",e),s.push(e.fileID))})),_e(i,s)}catch(t){ye=ye.filter((t=>!e.includes(t))),console.warn("[cloud.getTempFileURL] request failed",t),_e({},e)}}))}function _e(e,t){Object.keys(null!=e?e:{}).forEach((t=>{me.set(t,e[t])})),Ie.forEach((e=>{const n=Ae(e.fileIds,t);!1!==n&&(e.resolve(n),e.isDone=!0)})),Ie=Ie.filter((e=>!e.isDone))}function Ae(e,t=[]){try{if(Array.isArray(e)){const n={};return e.reduce(((e,n)=>{const r=me.get(n);if(!r){if(t.includes(n))return e;throw new Error("not found")}return e[n]=r,e}),n)}const n=me.get(e);if(!n){if(t.includes(e))return;throw new Error("not found")}return n}catch(e){return!1}}const xe=ae(!1,(e=>{if("$call"===e)return e=>se(Object.assign({},e,{parseBusinessInfo:!1}))})),Te={dataSources:ae(!0),callDataSource:se,callConnector:se,callModel:se,IS_WEDA_IDE:!1,version:K,utils:ve,getCloudInstance:ie,callGraphql:function(e){return a(this,void 0,void 0,(function*(){try{const t=h("beforeDSRequest");t&&t(e);const n=yield ce({name:m(!0),data:{mode:"graphql",params:e}},{unwrapResult:!0}),r=h("afterDSRequest");return r&&r(e,null,n),n}catch(t){const n=h("afterDSRequest");throw n&&n(e,t),t}}))},callFunction:ce,callWorkflow:function(e){return a(this,void 0,void 0,(function*(){return pe(e)}))},callWedaApi:pe,callCommonService:fe,getTempFileURL:function(e){const t=function(e){const t=e&&"object"==typeof e&&e.fileList?e.fileList:e;return"string"==typeof t||Array.isArray(t)?t:void 0}(e);if(!t||!t.length)return Promise.resolve();const n=Ae(t);return!1!==n?Promise.resolve(n):new Promise(((e,n)=>{!function(e,t,n){Ie.push({fileIds:e,resolve:t,reject:n});let r=(Array.isArray(e)?e:[e]).filter((e=>P(e)||T(e)));we.length&&(r=r.filter((e=>!we.includes(e))));r.length&&ye.length&&(r=r.filter((e=>!ye.includes(e))));r.length&&(r=r.filter((e=>!me.has(e))));if(!r.length)return;we=we.concat(r),clearTimeout(Oe);const o=Date.now();Se=!Se||o>Se?o+W.tempURLMaxWaitGap:Se,Oe=setTimeout(be,Se-o)}(t,e,n)}))},getDataSourceViewId:g,getDataSourceProfile:function(e){const t=h("dataSourceProfiles");if(!t||!t.length)return void console.warn("[weda-cloud-sdk]datasource profile is empty");const n="string"==typeof e?{val:e,key:"name"}:e,r="function"==typeof n?n:e=>e&&e[n.key]===n.val;return t.find(r)},getDataSourceProfileAsync:function(e){return a(this,void 0,void 0,(function*(){const t="string"==typeof e,n=t?{Name:e}:e,r=JSON.stringify(n);if(he[r])return ge(he[r]);if(t){const t=he._.find((t=>t.name===e));if(t)return ge(t)}const o=h("dataSourceProfiles");if((null==o?void 0:o.length)&&t){const t=o.find((t=>t.name===e));if(t)return ge(t)}const{swrMode:i}=n;delete n.swrMode;const s=function(e){const t={};Object.keys(e).reduce(((t,n)=>(t[n.charAt(0).toLowerCase()+n.slice(1)]=e[n],t)),t);const n={schema:{},methods:[]};return Object.keys(n).forEach((e=>{try{t[e]=JSON.parse(t[e])}catch(r){t[e]=n[e]}})),t}(yield pe({action:"RuntimeDescribeDataSource",data:n,swr:{swrMode:i}}));return he[r]=s,he._.push(s),ge(s)}))},setConfig:V,checkAuth:function(e){return pe({action:"DescribeWedaAccessResourcesByType",data:e})},setDataSourceDefaultParams:b};var Pe,Ue,Ce,De,Ee,ke,Ne,je,$e;Ue=new WeakMap,Ce=new WeakMap,De=new WeakMap,Ee=new WeakMap,ke=new WeakMap,Pe=new WeakSet,Ne=function(e){c(this,Ee,"f")===e&&(e.next?u(this,Ee,e.next,"f"):e.pre&&u(this,Ee,e.pre,"f")),e!==c(this,De,"f")&&(e.pre&&(e.pre.next=e.next),e.next&&(e.next.pre=e.pre),e.next=c(this,De,"f"),e.pre=null,c(this,De,"f")&&(c(this,De,"f").pre=e),u(this,De,e,"f"))},je=function(e){for(;e>0&&c(this,Ee,"f");){const{size:t}=c(this,Ee,"f").data;c(this,Ce,"f").delete(c(this,Ee,"f").data.key),c(this,Ee,"f").pre?(c(this,Ee,"f").pre.next=null,u(this,Ee,c(this,Ee,"f").pre,"f")):u(this,Ee,null,"f"),e-=t,this.calculatedSize-=t}},$e=function(e,t){const n=c(this,Ce,"f").get(e,t);return(null==n?void 0:n.node)&&c(this,Pe,"m",Ne).call(this,null==n?void 0:n.node),n};class Re{constructor(e,t){this.data={key:e,size:t},this.pre=null,this.next=null}}const Me=/^(?:(\d*);)?(.*)$/;function Le(e){const t=e||"";if("string"==typeof t){const e=t.match(Me);if(e)return{timestamp:Number(e[1])||0,value:e[2]}}}class Fe extends Map{constructor(){super()}get(e,t={}){const{refreshCache:n=!0}=t,r=super.get(e);let o=ee.getItemSync(e);if(r&&o){const t=Le(o);return t&&(o=t.value,n&&ee.setItem(e,`${Date.now()};${o}`)),{node:r,value:o}}}set(e,t,n={}){const{refreshCache:r=!0}=n||{},o=super.set(e,t.node);return r&&ee.setItemSync(e,`${Date.now()};${t.value}`),o}delete(e){const t=super.delete(e);return ee.removeItemSync(e),t}}const qe=new class{constructor({map:e=new Map,size:t,sizeCalculation:n=(()=>1),onInit:r}){return Pe.add(this),Ue.set(this,0),Ce.set(this,void 0),De.set(this,void 0),Ee.set(this,void 0),ke.set(this,void 0),this.calculatedSize=0,u(this,Ue,t||0,"f"),u(this,Ce,e,"f"),u(this,ke,n,"f"),this.calculatedSize=0,u(this,De,null,"f"),u(this,Ee,null,"f"),r&&r(this),this}list(){var e;let t=c(this,De,"f");const n=[];for(;null==t?void 0:t.data;)n.push({key:t.data.key,value:null===(e=c(this,Pe,"m",$e).call(this,t.data.key))||void 0===e?void 0:e.value}),t=t.next;return n}get(e,t){const n=c(this,Pe,"m",$e).call(this,e,t);return null==n?void 0:n.value}set(e,t,n){var r;const o=c(this,ke,"f").call(this,t,e);if(o>c(this,Ue,"f"))return c(this,Ce,"f").delete(e),void(this.calculatedSize-=o);const i=c(this,Pe,"m",$e).call(this,e,n),s=null==i?void 0:i.node,a=o-((null===(r=null==s?void 0:s.data)||void 0===r?void 0:r.size)||0);if(s)s.data.size=o,c(this,Ce,"f").set(e,{node:s,value:t},n);else{const r=new Re(e,c(this,ke,"f").call(this,t,e));null==c(this,De,"f")&&null===c(this,Ee,"f")&&u(this,Ee,r,"f"),r.next=c(this,De,"f"),c(this,De,"f")&&(c(this,De,"f").pre=r),u(this,De,r,"f"),c(this,Ce,"f").set(e,{node:r,value:t},n)}c(this,Pe,"m",je).call(this,this.calculatedSize+a-c(this,Ue,"f")),this.calculatedSize=this.calculatedSize+a}delete(e){const t=c(this,Ce,"f").get(e);t&&(c(this,De,"f")===t.node&&u(this,De,t.node.next,"f"),c(this,Ee,"f")===t.node&&u(this,Ee,t.node.pre,"f"),t.node.pre&&(t.node.pre.next=t.node.next),t.node.next&&(t.node.next.pre=t.node.pre),t.node.pre=null,t.node.next=null,this.calculatedSize=this.calculatedSize-t.node.data.size,c(this,Ce,"f").delete(e))}}({size:2048e3,sizeCalculation:(e,t)=>`${String(e)}${String(t)}`.length,map:new Fe,onInit:e=>{(ee.getKeysSync()||[]).filter((e=>e.startsWith("dataset_"))).map((e=>{const t=ee.getItemSync(e),{value:n,timestamp:r}=Le(t)||{value:t||"",timestamp:0};return{key:e,value:n,timestamp:r}})).sort(((e,t)=>e.timestamp-t.timestamp>=0?1:-1)).forEach((({key:t,value:n})=>{e.set(t,n,{refreshCache:!1})}))}});function We(e,t){if(!e)return;const n=Object.keys(e);if(!n.length)return{};return n.reduce(((n,r)=>{const o=e[r];return n[r]=void 0!==o.initialValue?o.initialValue:o.required?"":void 0,t&&(n[r]=o.sampleValue||n[r]),n}),{})}function Ve(e,t){if(!e)return{};const n=Object.keys(e),r={},o=n.reduce(((n,o)=>{const i=e[o];if("state"!==i.varType)return n;if(i.enableSyncLocal){const e=Be(null==t?void 0:t.appId,null==t?void 0:t.datasetProfileKey,o);e&&(r[e]=!0);try{const e=function(e,t,n,r=!0){const o=Be(e,t,n);if(o){const e=qe.get(o,{local:!!r});if("string"==typeof e)return JSON.parse(e)}return}(null==t?void 0:t.appId,null==t?void 0:t.datasetProfileKey,o,!1);n[o]=e}catch(e){console.error("get local state error:",e)}}return void 0===n[o]&&(n[o]=i.initialValue),n}),{});return function(e,t,n={}){const r=Ge(e,t);if(r){(ee.getKeysSync()||[]).forEach((e=>{!n[e]&&e.startsWith(r)&&Promise.resolve().then((()=>{qe.delete(e)}))}))}}(null==t?void 0:t.appId,null==t?void 0:t.datasetProfileKey,r),o}function Be(e,t,n){const r=Ge(e,t);if(r&&n)return`${r}${n}`}function Ge(e,t){if(e&&t)return`dataset_${e}_${t}_`}const ze=()=>a(void 0,void 0,void 0,(function*(){const e=yield a(void 0,void 0,void 0,(function*(){const e=h("__asyncRequire__");try{return e?yield e("@cloudbase/adapter-wx_mp"):require("@cloudbase/adapter-wx_mp")}catch(e){return null}}));return(null==e?void 0:e.WxRequest)?e.WxRequest:r.AbstractSDKRequest}));class Ke{constructor(e,t={}){const n=wx.connectSocket(Object.assign({url:e},t));return{set onopen(e){n.onOpen(e)},set onmessage(e){n.onMessage(e)},set onclose(e){n.onClose(e)},set onerror(e){n.onError(e)},send:e=>n.send({data:e}),close:(e,t)=>n.close({code:e,reason:t}),get readyState(){return n.readyState},CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3}}}const Je={genAdapterAsync:function(){return a(this,void 0,void 0,(function*(){const e=yield ze();return{root:{},reqClass:class extends e{constructor(e={}){super(e);const{timeout:t,timeoutMsg:n,restrictedMethods:r}=e;this._timeout=t||0,this._timeoutMsg=n||"请求超时",this._restrictedMethods=r||["get","post","upload","download"]}post(e){const t=this;return new Promise(((n,o)=>{const{url:i,data:s,headers:a}=e,c=wx.request({url:r.formatUrl("https:",i),data:s,timeout:t._timeout,method:"POST",header:a,success(e){n(e)},fail(e){o(e)},complete(e){if(!(null==e?void 0:e.errMsg))return;if(!t._timeout||-1===t._restrictedMethods.indexOf("post"))return;const{errMsg:n}=e;if("request:fail timeout"===n){console.warn(t._timeoutMsg);try{c.abort()}catch(e){}}}})}))}upload(e){const t=this;return new Promise((n=>{const{url:r,file:o,data:i,headers:s}=e,a=wx.getFileSystemManager(),c=wx.request({url:r,method:e.method,header:Object.assign({"content-type":" "},s),data:a.readFileSync(o),timeout:this._timeout,success(e){const t={statusCode:e.statusCode,data:e.data||{}};200===e.statusCode&&(null==i?void 0:i.success_action_status)&&(t.statusCode=parseInt(i.success_action_status,10)),n(t)},fail(e){n(e)},complete(e){if(!(null==e?void 0:e.errMsg))return;if(!t._timeout||-1===t._restrictedMethods.indexOf("upload"))return;const{errMsg:n}=e;if("request:fail timeout"===n){console.warn(t._timeoutMsg);try{c.abort()}catch(e){}}}})}))}download(e){const t=this;return new Promise(((n,o)=>{const{url:i,headers:s}=e,a=wx.downloadFile({url:r.formatUrl("https:",i),header:s,timeout:this._timeout,success(e){200===e.statusCode&&e.tempFilePath?n({statusCode:200,tempFilePath:e.tempFilePath}):n(e)},fail(e){o(e)},complete(e){if(!(null==e?void 0:e.errMsg))return;if(!t._timeout||-1===t._restrictedMethods.indexOf("download"))return;const{errMsg:n}=e;if("request:fail timeout"===n){console.warn(t._timeoutMsg);try{a.abort()}catch(e){}}}})}))}},wsClass:Ke,localStorage:Z,primaryStorage:r.StorageType.local,getAppSign(){const e=wx.getAccountInfoSync();return"undefined"!=typeof App||"undefined"!=typeof getApp||wx.onAppHide||wx.offAppHide||wx.onAppShow||wx.offAppShow?(null==e?void 0:e.miniProgram)?e.miniProgram.appId:"":(null==e?void 0:e.plugin)?e.plugin.appId:""}}}))},genAdapter:void 0,isMatch:te,runtime:"wx_mp"};function He(e,t=!1){return a(this,void 0,void 0,(function*(){const{url:n}=e,r=s(e,["url"]);"PATCH"===r.method&&(r.headers||(r.headers={}),r.headers["X-HTTP-Method-Override"]="PATCH",r.method="POST"),r.body&&"string"!=typeof r.body&&(r.body=JSON.stringify(r.body,((e,t)=>{if(t&&""!==t)return t})));const o=N(n),i=n.slice(0,n.indexOf(o)),[a,c]=i.match(/:\/\/(.*)$/)||[i,i];r.headers["x-host"]=c;try{r.headers["User-Agent"]=yield wx.getRendererUserAgent()}catch(e){}const u=h("envID");return{url:A()||!t?n:`${n.replace(c,"tcb-api.tencentcloudapi.com")}${-1!=n.indexOf("?")?`&env=${u}`:`?env=${u}`}`,body:r.body,method:r.method,headers:r.headers}}))}const Xe={storage:new D({localStorage:Z}),captchaOptions:{openURIWithCallback:e=>{let t={},n=e;const r=e.match(/^(data:.*?)(\?[^#\s]*)?$/);if(r){n=r[1];const e=r[2];e&&(t=function(e){e=e.replace(/^\?/,"");const t={};return e.split("&").forEach((e=>{let[n,r]=e.split("=");n=decodeURIComponent(n),r=decodeURIComponent(r),n&&(t[n]?Array.isArray(t[n])?t[n].push(r):t[n]=[t[n],r]:t[n]=r)})),t}(e))}const{token:o}=t,i=s(t,["token"]);return/^data:/.test(n)&&!o?Promise.reject({error:"invalid_argument",error_description:`invlaie captcha data: ${e}`}):o?new Promise((e=>{console.log("wait for captcha..."),L.emit("CAPTCHA_DATA_CHANGE",Object.assign(Object.assign({},i),{token:o,url:n})),L.once("RESOLVE_CAPTCHA_DATA",(t=>{e(t)}))})):Promise.reject({error:"unimplemented",error_description:"need to impl captcha data"})}}};function Qe(e){var t,n;return a(this,void 0,void 0,(function*(){const r=h("__asyncRequire__"),o=yield j(h(),null===(n=null===(t=h("tcbApiOrigin"))||void 0===t?void 0:t.replace)||void 0===n?void 0:n.call(t,/^https?:\/\//,"")),{generateAuthInstance:i}=r?yield r("@cloudbase/auth"):require("@cloudbase/auth"),{authInstance:s}=i(Ye(e,o),{clientId:h("tcbClientId"),env:h("envID"),apiOrigin:h("tcbApiOrigin"),cache:null,platform:{runtime:(null==o?void 0:o.runtime)||Je.runtime,adapter:(null==o?void 0:o.genAdapter())||(yield Je.genAdapterAsync())}});return s}))}function Ye(e,t,n){let r={};if(n){const{genOauthAdaper:e=(()=>({}))}=n;r=e({generateOauthClientRequest:k,OauthClientStorgeBase:D})}const{request:o}=r,i=s(r,["request"]),c=function(e){return Object.assign({baseRequest:k(A()?e=>a(this,void 0,void 0,(function*(){const{url:t,body:n,method:r,headers:o}=yield He(e,!0);return new Promise(((e,i)=>{wx.request({url:t,data:n,method:r,header:o,success(t){"object"==typeof t.data?e(t.data):i(new Error(`resp data error for - ${t.data}`))},fail(e){i(new Error(e.errMsg))}})}))})):t=>a(this,void 0,void 0,(function*(){const{url:n,method:r,headers:o,body:i}=yield He(t);return e.callFunction({name:"httpOverCallFunction",data:{url:n,method:r,headers:Object.assign({origin:"https://servicewechat.com"},o),body:i}}).then((({result:e})=>e.body),(e=>{throw new Error(e.errMsg)}))})))},Xe)}(e);return Object.assign(Object.assign(Object.assign(Object.assign({persistence:"local",region:h("region")||"ap-shanghai"},t),c),i),{baseRequest:o||c.baseRequest})}function Ze(e){return I(Qe,e)}function et(){return a(this,void 0,void 0,(function*(){const{auth:e}=yield ot();return e.getAccessToken()}))}let tt;const nt=()=>a(void 0,void 0,void 0,(function*(){const e=h("envID"),t=h("gatewayOrigin"),n=h("__asyncRequire__"),{reqClass:r}=yield Je.genAdapterAsync(),o=new r,{createAi:i}=n?yield n("@cloudbase/ai"):require("@cloudbase/ai");return i({env:e,req:o,getAccessToken:et,baseUrl:t})}));function rt(){return a(this,void 0,void 0,(function*(){const e=h(),t=e.tcbApiOrigin?e.tcbApiOrigin.replace(/^https?:\/\//,""):"",n=yield j(e,t);let r;if(A()){const o=e.__asyncRequire__,[i,{registerFunctions:s},{registerStorage:a},{registerAuth:c},{registerAi:u}]=yield Promise.all([o?o("@cloudbase/js-sdk/app"):{},o?o("@cloudbase/js-sdk/functions"):{},o?o("@cloudbase/js-sdk/storage"):{},o?o("@cloudbase/auth"):require("@cloudbase/auth"),o?o("@cloudbase/ai"):require("@cloudbase/ai")]);let d=i.default||module;if(c(d),s(d),a(d),u(d),!n){const e=yield Je.genAdapterAsync();Je.genAdapter=()=>e}d.useAdapters(n||Je),r=d.init({timeout:6e4,env:e.envID,clientId:e.tcbClientId||e.envID,region:e.region}),e.tcbApiOrigin&&d.registerEndPoint(`//${t}/web`);const l=r.auth(Ye(r,{anonymousSignInFunc:st},n));return{app:r,auth:l}}return e.resourceAppid?(r=wx.cloud.Cloud({resourceAppid:e.resourceAppid,resourceEnv:e.envID}),yield r.init()):(r=wx.cloud,r.init({env:e.envID})),r.ai&&(r._ai=r.ai),r.ai=nt,{app:r,auth:yield Ze(r)}}))}function ot(){return I(rt)}function it(){return a(this,void 0,void 0,(function*(){const{auth:e}=yield ot();let t,n;try{yield e.getAccessToken(),t=!0}catch(e){}try{n=yield e.loginScope()}catch(e){}return{notLogin:!t,isAnonymous:!t||"anonymous"===n,hasLogin:!!t&&"anonymous"!==n}}))}function st(){return a(this,void 0,void 0,(function*(){const{auth:e}=yield ot(),{code:t}=yield wx.login(),{appId:n}=wx.getAccountInfoSync().miniProgram,{provider_token:r}=yield e.grantProviderToken({provider_id:n,provider_code:t});yield e.signInAnonymously({provider_token:r})}))}const at="lcap-user-session",ct=n.observable({currentUser:null});function ut(e){return a(this,void 0,void 0,(function*(){if(ct.currentUser&&!e.force)return ct.currentUser;const{app:t}=yield ot(),n=yield fe({wx_phone:(null==e?void 0:e.phoneCloudID)?wx.cloud.CloudID(e.phoneCloudID):void 0,methodName:"signIn",params:e},t),r=Object.assign({},n,e,{lastUpdateTime:Date.now()});if(delete r.phoneCloudID,r.userExtend)try{const e=JSON.parse(r.userExtend);r.wxOpenId=r.wxOpenId||(null==e?void 0:e.open_id)||""}catch(e){}if(!r.wxOpenId)try{const{Data:{Data:e}}=yield fe({methodName:"callWedaApi",params:{action:"InvokeComponentWxModule",data:{Method:"GetWxContext"}}},t),n="string"==typeof e?JSON.parse(e):e;r.wxOpenId=(null==n?void 0:n.FROM_OPENID)||(null==n?void 0:n.OPENID)}catch(e){console.error("get wxcontext fail:",e)}return ct.currentUser=r,wx.setStorageSync(at,r),r}))}var dt={signIn:ut,signOut:function(){return a(this,void 0,void 0,(function*(){const e=yield it(),{auth:t}=yield ot();ct.currentUser=null,e.hasLogin&&t.signOut(),e.isAnonymous||(yield ut({userType:"anonymousUser"}))}))},getUserInfo:function(e=!1){return a(this,void 0,void 0,(function*(){if(!e&&ct.currentUser)return ct.currentUser;const t=wx.getStorageSync(at);return t?!t.lastUpdateTime||Date.now()-t.lastUpdateTime>2592e5?null:(ct.currentUser=Object.assign(Object.assign({},ct.currentUser),t),t):t}))},setCurrentUserInfo(e={}){for(const t in e)ct.currentUser&&(ct.currentUser[t]=e[t])},get currentUser(){return ct.currentUser?Object.assign({},ct.currentUser):null},getUrlWithOpenidToken:function(e){return a(this,void 0,void 0,(function*(){if(void 0===wx||"function"!=typeof wx.login||!e)return"";const{auth:t}=yield ie();if(!t)return"";const n=t=>{let[n="",r="",o=""]=e.split(/(?:\?|#)+/);return r.startsWith("/")&&(o=r,r=""),`${n}?${r}${r?"&":""}wx_access_token=${t}${o?"#":""}${o}`},{miniProgram:r}=wx.getAccountInfoSync();if(A())return new Promise((e=>{wx.login({success:o=>a(this,void 0,void 0,(function*(){try{const{provider_token:i}=yield t.grantProviderToken({provider_code:o.code,provider_id:null==r?void 0:r.appId}),s=n(i);e(s)}catch(t){console.log("=======> [getUrlWithOpenidToken]: grantProviderToken error ",t),e("")}})),fail:t=>{console.log("=======> [getUrlWithOpenidToken]: wx.login fail ",t),e("")}})}));try{const e=yield pe({action:"GetMiniProgramUserTicket",data:{Type:"externalUser",OnlyOpenId:!0}}),o=(null==e?void 0:e.token)||e;if(!o)return"";const{provider_token:i}=yield t.grantProviderToken({provider_id:null==r?void 0:r.appId,provider_access_token:`${h("envID")} ${o}`});return n(i)}catch(e){}return""}))},openIdLoginInWxApp:function(){return a(this,void 0,void 0,(function*(){if(void 0===wx||"function"!=typeof wx.login)return!1;const{auth:e}=yield ot();if(!e)return!1;let t=!0;const{miniProgram:n}=wx.getAccountInfoSync(),r=null==n?void 0:n.appId,o=yield new Promise(((e,t)=>{wx.login({success:t=>a(this,void 0,void 0,(function*(){e(t.code)})),fail:e=>{console.log("=======> [openIdLoginInWxApp]: wx.login fail ",e);const n=new Error(null==e?void 0:e.errMsg);n.code=null==e?void 0:e.errno,t(n)}})}));try{const i={provider_id:r,provider_params:{provider_code_type:"open_id"}};o&&(i.provider_code=o,i.provider_params.appid=null==n?void 0:n.appId);const{provider_token:s}=yield e.grantProviderToken(i),a=yield e.signInWithProvider({provider_token:s});if(a.code)throw console.log("=======> [openIdLoginInWxApp]: signInWithProvider error ",a),a;t=!0}catch(e){throw console.log("=======> [openIdLoginInWxApp]: error ",e),e}return yield ut({userType:"externalUser",force:!0,providerId:r}),t}))},unionIdLoginInWxApp:function(){return a(this,void 0,void 0,(function*(){if(void 0===wx||"function"!=typeof wx.login)return!1;const{auth:e}=yield ie();if(!e){return new Error("auth instance not found")}return new Promise(((t,n)=>{wx.login({success:r=>a(this,void 0,void 0,(function*(){const{miniProgram:o}=wx.getAccountInfoSync(),i=null==o?void 0:o.appId;try{const{provider_token:s}=yield e.grantProviderToken({provider_code:r.code,provider_id:i,provider_params:{provider_code_type:"union_id",appid:null==o?void 0:o.appId}}),a=yield e.signInWithProvider({provider_id:i,provider_token:s});if(a.code)return console.log("=======> [unionIdLoginInWxApp]: signInWithProvider error ",a),void n(a);yield ut({userType:"externalUser",force:!0}),t(!0)}catch(e){console.log("=======> [unionIdLoginInWxApp]: error ",e),n(e)}})),fail:e=>{console.log("=======> [unionIdLoginInWxApp]: wx.login fail ",e);const t=new Error(null==e?void 0:e.errMsg);t.code=null==e?void 0:e.errno,n(t)}})}))}))},modifyCurrentUser:function({nickName:e="",userName:t="",avatarUrl:n="",description:r=""}={}){return a(this,void 0,void 0,(function*(){const{userType:o,wedaId:i,nickName:s,avatarUrl:a,userName:c,description:u}=ct.currentUser;if("anonymousUser"===o||!i)return{};try{const{auth:d}=yield ot();return yield d.updateUserBasicInfo({user_id:i,nickname:e||s||"",username:t||c||"",description:r||u||"",avatar_url:n||a||""}),yield ut({userType:o,force:!0})}catch(e){console.log("=======> [modifyCurrentUser]: error ",e)}return{}}))},judgePasswordFreeLogin:function(){return a(this,void 0,void 0,(function*(){if(void 0!==tt)return tt;try{const{auth:e}=yield ot(),{appId:t}=wx.getAccountInfoSync().miniProgram,n=yield e.getProviderSubType({provider_id:t});return tt="NO_AUTH_LOGIN"===(null==n?void 0:n.provider_sub_type),tt}catch(e){return console.log("========> judgePasswordFreeLogin error",e),!1}}))}};const lt=Object.assign(Te,dt);function ft(){var e;return a(this,void 0,void 0,(function*(){const{app:t,auth:n}=yield ot(),r=yield it();let o=r.isAnonymous||r.notLogin?"anonymousUser":"externalUser";const{miniProgram:i}=wx.getAccountInfoSync();let s=null==i?void 0:i.appId,c=!0;const u=h("customConfig")||{},d=()=>a(this,void 0,void 0,(function*(){A()&&r.notLogin?yield st():A()||"openId"===h("__defaultLoginType__")&&(yield dt.openIdLoginInWxApp(),c=!1,o="externalUser")}));if("anonymousUser"==o&&(!(null==u?void 0:u.login)||r.hasLogin&&!(null==u?void 0:u.forceLogin)?yield d():(c=!!(null===(e=null==u?void 0:u.loginConfig)||void 0===e?void 0:e.needSignIn),yield u.login({app:t,auth:n,loginState:r,defaultLogin:d}))),c){const e=e=>{console.warn("[weda-cloud-sdk] failed to sign-in/getUserInfo weda backend",e)};yield dt.signIn({userType:o,force:!0,providerId:s}).catch(e)}return t.auth&&(t._auth=t.auth),t.auth=n,{app:t,auth:n}}))}function pt(){return a(this,void 0,void 0,(function*(){return I(ft)}))}Object.defineProperty(lt,"currentUser",{get:()=>dt.currentUser}),v({initTcb:pt}),e.CLOUD_API=Te,e.CLOUD_SDK=lt,e.DATASET_CONTEXT=f,e.DS_SDK=xe,e.EXTRA_API=q,e.OauthClientStorgeBase=D,e.PromiseAllSettled=x,e.TCBError=d,e._generatePrivatelinkAdapter=j,e.callDataSource=se,e.createDataset=function(e,t,r){v({currentPageId:e});const o=(h("datasetProfiles")||{})[e],i=n.observable({state:{$status:{}},params:{}});if(f[e]=i,!o)return i;const s=We(o.params,t),a=Ve(o.state,{appId:null==r?void 0:r.appId,datasetProfileKey:e});return Object.assign(i.params,s),Object.assign(i.state,a),i},e.createParamsVar=We,e.createSetDefaultParams=function(e){return t=>{b(e,t)}},e.createStateDataSourceVar=function(e,t){var n,r;return a(this,void 0,void 0,(function*(){const o=null===(n=f[e])||void 0===n?void 0:n.state,i=h("datasetProfiles")||{},s=null===(r=i[e])||void 0===r?void 0:r.state;if(!o||!s)return;Object.keys(s).forEach((n=>a(this,void 0,void 0,(function*(){const r=s[n];if("datasource"===r.varType){if(!r.initMethod||!r.initMethod.name)return o[n]={},void(o.$status[n]={status:"idle"});try{o.$status[r.name]={status:"loading"};const{initMethod:n}=r,i=yield Te.callDataSource({name:r.dataSourceName,methodName:n.name,params:t(n.params,n),options:{showLoading:!0}});F(`${e}.${r.name}`,i)}catch(t){console.error(`[weda-cloud-sdk] 初始化变量 ${e}.${r.name} 失败`,t),F(`${e}.${r.name}`,t)}}}))))}))},e.createStaticStateVar=Ve,e.deepClone=U,e.deepMerge=function e(t,n){const r=Object.assign({},t);return Object.keys(n).forEach((t=>{n.hasOwnProperty(t)&&("object"!=typeof n[t]||Array.isArray(n[t])||"object"!=typeof r[t]?r[t]=n[t]:r[t]=e(r[t],n[t]))})),r},e.execOnce=I,e.generateOauthClientRequest=k,e.generateParamsParser=function(e){return t=>{if(!t)return t;const n={};return Object.keys(t).forEach((r=>{n[r]=t[r](e.app,e.$page,e.$w)})),n}},e.getAccessToken=et,e.getCommonCloudFnName=m,e.getConfig=h,e.getDataSourceViewId=g,e.getDatasetProfiles=C,e.getDatasourceCloudFnName=function(e){return p.useLegacyDatasource?`lcap-${e.id}-${e.name}${p.isProd?"":"-preview"}`:"lowcode-datasource"+(p.isProd?"":"-preview")},e.getDefaultParams=_,e.getTcbInstance=ot,e.getUrlPath=N,e.hasOwn=l,e.initTcb=pt,e.isObject=P,e.isSameArray=y,e.isString=T,e.pick=S,e.setConfig=v,e.setDatasetProfiles=function(e){v({datasetProfiles:Object.assign(h("datasetProfiles")||{},e)})},e.setDefaultParams=b,e.setLocalDatasetState=function(e,t,n,r){var o,i;const s=Be(e,t,n);if(s){const a=(null===(o=C(t))||void 0===o?void 0:o.state)||{};if(void 0===r)qe.delete(s);else{const t=JSON.stringify(r);let o;try{o=JSON.stringify(null===(i=null==a?void 0:a[n])||void 0===i?void 0:i.initialValue)}catch(e){}if(t===o)qe.delete(s);else try{qe.set(s,t)}catch(t){if(/exceed storage max size/.test(null==t?void 0:t.message)||"QuotaExceededError"===t.name||"NS_ERROR_DOM_QUOTA_REACHED"===t.name){(ee.getKeysSync()||[]).forEach((t=>{t.startsWith("dataset_")&&!t.startsWith(`dataset_${e}`)&&Promise.resolve().then((()=>{qe.delete(s)}))}))}else qe.delete(s);throw t}}}},e.useTcbApi=A,Object.defineProperty(e,"__esModule",{value:!0})}));
