"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.watchAndSyncDatasetState2Local = exports.runWatchers = void 0;
const mobx_1 = require("mobx");
const util_1 = require("./util");
const weda_cloud_sdk_1 = require("@cloudbase/weda-cloud-sdk");
/**
 *
 * @param {*} param
 * @returns Dipsonsers
 */
function runWatchers({ watchEffects = {}, watch = {}, watchState = {}, watchWidget = {} }, mpInst) {
    const weappInst = mpInst._getInstance();
    const disposers = [];
    Object.keys(watchEffects).map((name) => {
        const fn = watchEffects[name];
        if (fn instanceof Function) {
            disposers.push((0, mobx_1.autorun)(fn.bind(weappInst)));
        }
        else {
            console.error(`WatchEffect(${name}) of ${mpInst.is} is not a function.`);
        }
    });
    // # watch props
    Object.keys(watch).map((key) => runWatcher(parseWatcher(watch[key]), weappInst.node, key, 'watch'));
    // # watch state
    Object.keys(watchState).map((key) => runWatcher(parseWatcher(watchState[key]), weappInst.state, key, 'watchState'));
    // # watch widgets
    Object.keys(watchWidget).map((key) => runWatcher(parseWatcher(watchWidget[key]), weappInst.widgets, key, 'watchWidgets'));
    return disposers;
    function runWatcher(ctx, target, key, label) {
        const { handler, immediate } = ctx || {};
        if (!handler) {
            console.error(`Invalid ${label}(${key}) of ${mpInst.is}, watch must a function or {handler: function}`);
            return;
        }
        const disposer = (0, mobx_1.reaction)(() => (0, util_1.getDeep)(target, key), handler.bind(weappInst), { fireImmediately: immediate });
        disposers.push(disposer);
    }
}
exports.runWatchers = runWatchers;
function parseWatcher(watcher) {
    if (!watcher)
        return;
    if (watcher instanceof Function) {
        return { handler: watcher, immediate: false };
    }
    const { handler, immediate = false } = watcher;
    if (!(handler instanceof Function))
        return;
    return { handler, immediate };
}
function watchAndSyncDatasetState2Local(appId, datasetProfileKey, dataset) {
    const disposes = [];
    const stateProfile = (0, weda_cloud_sdk_1.getDatasetProfiles)(datasetProfileKey)?.state || {};
    for (const key in stateProfile) {
        const config = stateProfile[key];
        if (config.enableSyncLocal) {
            const dispose = (0, mobx_1.autorun)((r) => {
                try {
                    (0, weda_cloud_sdk_1.setLocalDatasetState)(appId, datasetProfileKey, key, dataset[key]);
                }
                catch (e) {
                    console.error('setLocalDatasetState error:', e);
                }
            });
            disposes.push(dispose);
        }
    }
    return disposes;
}
exports.watchAndSyncDatasetState2Local = watchAndSyncDatasetState2Local;
